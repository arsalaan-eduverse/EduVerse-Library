<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>EduVerse Library ‚Äî Polished Black & Gold</title>
<!-- Libre Franklin -->
<link href="https://fonts.googleapis.com/css2?family=Libre+Franklin:wght@300;400;600;700&display=swap" rel="stylesheet">

<!-- Firebase (auth for forgot-password) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getAuth, setPersistence, browserLocalPersistence, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBzXsyG-h3NKZzHBkJ89RM1fKWzsOLNYtE",
    authDomain: "eduverse-library.firebaseapp.com",
    projectId: "eduverse-library",
    storageBucket: "eduverse-library.appspot.com",
    messagingSenderId: "294742664429",
    appId: "1:294742664429:web:bff2d66a347a46cac1d8e4"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  setPersistence(auth, browserLocalPersistence).catch(console.warn);

  // Expose a helper for password reset
  window.resetPasswordFirebase = async (email) => {
    if(!email) return alert('Enter email to reset');
    try{ await sendPasswordResetEmail(auth, email); alert('Password reset link sent to '+email); }catch(e){ console.error(e); alert('Failed to send reset: '+(e.message||e)); }
  }

  // simple exposed sign out
  window.signOutFirebase = async ()=>{
    try{ await signOut(auth); console.log('signed out firebase'); }catch(e){console.warn(e)}
  }
</script>

<style>
  :root{
    --bg: #fbf7ef; /* original warm background kept */
    --paper: #fffdf8;
    --muted: #a89a8f;
    --text:#111;
    --gold:#b98a2b;
    --gold-strong:#d4a24a;
    --card-shadow: 0 10px 30px rgba(0,0,0,0.12);
    --glass: rgba(255,255,255,0.6);
  }
  [data-theme="dark"]{
    --bg:#0b0b0b;
    --paper:#0f0f0f;
    --muted:#bfb9b2;
    --text:#f6f3f0;
    --gold:#c79a3d;
    --gold-strong:#e0b564;
    --card-shadow: 0 12px 38px rgba(0,0,0,0.6);
    --glass: rgba(255,255,255,0.04);
  }

  *{box-sizing:border-box}
  body{font-family:'Libre Franklin',system-ui,Arial;margin:0;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased;min-height:100vh}
  .wrap{max-width:1200px;margin:18px auto;padding:18px}

  header{display:flex;flex-direction:column;gap:12px}
  .topbar{display:flex;align-items:center;gap:12px}
  .brand{font-weight:700;font-size:20px;color:var(--gold-strong);display:flex;flex-direction:column}
  .brand .tag{font-size:12px;color:var(--muted);font-weight:400}

  .tools{margin-left:auto;display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border-radius:10px;background:var(--gold);color:#040404;border:none;cursor:pointer;font-weight:700}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text);font-weight:600}
  .small{font-size:13px;color:var(--muted)}

  /* Two-row navigation */
  nav.secondary{display:flex;gap:8px;flex-wrap:wrap;align-items:center;padding:6px 0}
  .nav-item{padding:8px 12px;border-radius:999px;background:transparent;border:1px solid transparent;color:var(--muted);cursor:pointer}
  .nav-item.active{background:linear-gradient(90deg,var(--gold),var(--gold-strong));color:#0b0b0b;border-color:transparent;font-weight:700}
  .nav-item.hidden{display:none}

  .grid{display:grid;grid-template-columns:1fr 320px;gap:18px;margin-top:14px}
  .card{background:var(--paper);padding:16px;border-radius:12px;box-shadow:var(--card-shadow);border:1px solid rgba(0,0,0,0.03)}

  .book-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .book-card{display:flex;gap:12px;align-items:flex-start;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);background:linear-gradient(180deg,transparent, rgba(0,0,0,0.01))}
  .book-cover{width:72px;height:100px;border-radius:6px;object-fit:cover;flex-shrink:0;background:#eee}
  .book-meta{flex:1}
  .book-title{font-weight:700;color:var(--gold-strong);margin-bottom:6px}
  .book-author{font-size:13px;color:var(--muted);margin-bottom:8px}
  .book-actions{display:flex;gap:8px}

  /* Chat panel adjustments */
  .chat-panel{position:fixed;right:20px;bottom:20px;height:520px;width:420px;transform:translateY(20px);transition:all .24s ease;z-index:1500;opacity:0;pointer-events:none}
  .chat-panel.open{opacity:1;pointer-events:auto;transform:translateY(0)}
  .chat-panel .panel{height:100%;display:flex;flex-direction:column;background:var(--paper);border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.4);overflow:hidden}
  .chat-body{flex:1;overflow:auto;padding:12px}
  .chat-input{display:flex;padding:12px;border-top:1px solid rgba(0,0,0,0.04);gap:8px}

  .tabs{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
  .tab{padding:8px 12px;border-radius:999px;background:transparent;border:1px solid rgba(0,0,0,0.03);cursor:pointer;color:var(--muted)}
  .tab.active{background:var(--gold);color:#0b0b0b}

  footer.app-foot{margin-top:20px;color:var(--muted);text-align:center;font-size:13px}

  /* responsive */
  @media (max-width:980px){ .grid{grid-template-columns:1fr} .chat-panel{right:10px;left:10px;width:auto} }
</style>
</head>
<body data-theme="dark">
<div class="wrap">
  <header>
    <div class="topbar">
      <div class="brand">
        <div>EduVerse <span style="font-weight:800;color:var(--gold)">Library</span></div>
        <div class="tag">Learn ‚Ä¢ Share ‚Ä¢ Grow</div>
      </div>

      <div class="tools">
        <input id="globalSearch" class="small" placeholder="Search titles, authors or topics" style="padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)">
        <button id="themeToggle" class="btn ghost">Toggle Theme</button>
        <div id="userArea" class="small">Not signed in</div>
        <button id="openChatBtn" class="btn ghost">Chat</button>
        <button id="navProfileBtn" class="btn">Profile</button>
      </div>
    </div>

    <!-- secondary nav: two rows feel achieved by header + this secondary nav -->
    <nav class="secondary" id="secondaryNav">
      <button class="nav-item" data-page="home">Home</button>
      <button class="nav-item" data-page="education">Education üìö</button>
      <button class="nav-item" data-page="novels">Novels & Poems ‚úçÔ∏è</button>
      <button class="nav-item" data-page="languages">Languages üåç</button>
      <button class="nav-item" data-page="ai">AI Tutor ü§ñ</button>
      <button class="nav-item" data-page="qa">Self-Test üß©</button>
      <button class="nav-item" data-page="community">Community üí¨</button>
      <button class="nav-item" id="loginTab" data-page="login">Login</button>
    </nav>
  </header>

  <main>
    <div class="grid">
      <section>
        <div id="page" class="card"> <!-- SPA content injected --> </div>
        <div class="small" style="margin-top:10px">All free works must include license & source; paid items link to purchase pages to avoid copyright issues.</div>
      </section>

      <aside>
        <div class="card">
          <h4 style="margin:0">Navigation</h4>
          <div style="height:10px"></div>
          <div id="sideNavList" class="tabs">
            <!-- side shortcuts (duplicates of top nav, kept minimal) -->
            <button class="tab" data-page="home">Home</button>
            <button class="tab" data-page="education">Education</button>
            <button class="tab" data-page="novels">Novels</button>
            <button class="tab" data-page="community">Community</button>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="card">
          <h4 style="margin:0">Your Friends</h4>
          <div id="friendsList" style="margin-top:10px"></div>
        </div>
      </aside>
    </div>
  </main>

  <footer class="app-foot">EduVerse Library ‚Äî Polished Black & Gold ‚Ä¢ Keep repository on GitHub</footer>
</div>

<!-- Chat panel -->
<div id="chatPanel" class="chat-panel">
  <div class="panel">
    <div style="padding:14px;border-bottom:1px solid rgba(0,0,0,0.04);display:flex;align-items:center">
      <strong id="chatWith">Chat</strong><div style="flex:1"></div><button id="closeChat" class="btn ghost">Close</button>
    </div>
    <div id="chatBody" class="chat-body"></div>
    <div class="chat-input">
      <input id="chatText" placeholder="Message..." style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.04);background:transparent;color:var(--text)" />
      <button id="sendChat" class="btn">Send</button>
    </div>
  </div>
</div>

<script>
/* Lightweight SPA behaviour (single-file). This is a polished replacement index.html.
   Key features implemented per brief:
   - Two-row nav, active highlight
   - Login hidden after sign-in
   - Education vs Novels separation
   - Chat panel sizing improved
   - AI Tutor page placeholder
   - After saving profile -> redirect Home
   - Book covers (copyright-free placeholder pics)
   - Theme toggle (kept intact)
*/

// LocalStorage keys
const LS_USERS = 'ev_users_v2';
const LS_SESS = 'ev_session_v2';
const LS_BOOKS = 'ev_books_v2';
const LS_QA = 'ev_qa_v2';
const LS_CHATS = 'ev_chats_v2';

const page = document.getElementById('page');
const secondaryNav = document.getElementById('secondaryNav');
const navItems = secondaryNav.querySelectorAll('.nav-item');
const sideNavList = document.getElementById('sideNavList');
const friendsList = document.getElementById('friendsList');
const loginTab = document.getElementById('loginTab');
const userArea = document.getElementById('userArea');

let BOOKS = [];
let currentUser = null;
let activeChat = null;

function read(key, fallback){ try{ const v = localStorage.getItem(key); return v?JSON.parse(v):fallback; }catch(e){return fallback;} }
function write(key,val){ localStorage.setItem(key, JSON.stringify(val)); }

function loadUsers(){ return read(LS_USERS, []); }
function saveUsers(u){ write(LS_USERS, u); }
function createId(pref='u'){ return pref + Date.now().toString(36) + Math.floor(Math.random()*999).toString(36); }
function findUserByUsername(name){ if(!name) return null; const low = name.trim().toLowerCase(); return loadUsers().find(u=>u.usernameLower===low); }
function findUserById(id){ return loadUsers().find(u=>u.id===id); }

function setSession(id){ write(LS_SESS, {userId:id}); }
function clearSession(){ localStorage.removeItem(LS_SESS); currentUser=null; renderUserArea(); }
function getSession(){ return read(LS_SESS, null); }

// Navigation helpers
function setActiveNav(pageName){ navItems.forEach(n=> n.classList.toggle('active', n.dataset.page===pageName)); const sideTabs = sideNavList.querySelectorAll('.tab'); sideTabs.forEach(t=> t.classList.toggle('active', t.dataset.page===pageName)); }

secondaryNav.addEventListener('click', (e)=>{ if(e.target.matches('.nav-item')) showPage(e.target.dataset.page); });
sideNavList.addEventListener('click', (e)=>{ if(e.target.matches('.tab')) showPage(e.target.dataset.page); });

function showPage(pageName){ setActiveNav(pageName);
  if(pageName==='login') return renderLogin();
  if(pageName==='profile') return renderProfile();
  if(pageName==='home') return renderHome();
  if(pageName==='education') return renderEducation();
  if(pageName==='novels') return renderNovels();
  if(pageName==='languages') return renderLanguages();
  if(pageName==='ai') return renderAITutor();
  if(pageName==='qa') return renderQA();
  if(pageName==='community') return renderCommunity();
  renderHome();
}

/* ---------- Pages ---------- */
function renderLogin(){
  page.innerHTML = `
    <h2>Sign in</h2>
    <div style="height:8px"></div>
    <div class="card">
      <h3>Local Login</h3>
      <input id="loginUser" placeholder="Username" style="width:100%;margin-top:8px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.04)" />
      <input id="loginEmail" placeholder="Email (used for password reset)" type="email" style="width:100%;margin-top:8px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.04)" />
      <div style="height:8px"></div>
      <div style="display:flex;gap:8px">
        <button id="doLogin" class="btn">Login</button>
        <button id="toRegister" class="btn ghost">Register</button>
      </div>
      <div style="height:8px"></div>
      <button id="forgotPassBtn" class="btn ghost small">Forgot Password?</button>
    </div>
  `;

  document.getElementById('doLogin').onclick = ()=>{
    const uname = document.getElementById('loginUser').value.trim();
    if(!uname) return alert('Enter username');
    const user = findUserByUsername(uname);
    if(!user) return alert('User not found. Please register.');
    setSession(user.id); currentUser = user; renderUserArea(); showPage('home');
  };

  document.getElementById('toRegister').onclick = ()=> renderRegister();
  document.getElementById('forgotPassBtn').onclick = ()=>{
    const email = document.getElementById('loginEmail').value.trim();
    if(!email) return alert('Enter email for reset.');
    window.resetPasswordFirebase(email);
  };
}

function renderRegister(){
  page.innerHTML = `
    <h2>Create account</h2>
    <div style="height:8px"></div>
    <div class="card">
      <h3>Register</h3>
      <input id="regUser" placeholder="Choose username (unique)" style="width:100%;margin-top:8px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.04)" />
      <input id="regEmail" placeholder="Enter your email" type="email" style="width:100%;margin-top:8px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.04)" />
      <textarea id="regBio" placeholder="Short bio (optional)" style="width:100%;min-height:80px;margin-top:8px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.04)"></textarea>
      <div style="height:12px"></div>
      <div style="display:flex;gap:8px">
        <button id="createAccount" class="btn">Create Account</button>
        <button id="backLogin" class="btn ghost">Back</button>
      </div>
    </div>
  `;
  document.getElementById('backLogin').onclick = ()=> showPage('login');
  document.getElementById('createAccount').onclick = ()=>{
    const uname = document.getElementById('regUser').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const bio = document.getElementById('regBio').value.trim();
    if(!uname) return alert('Choose a username');
    if(!email) return alert('Email is required');
    if(findUserByUsername(uname)) return alert('Username taken ‚Äî try another');
    const users = loadUsers(); const id = createId('u');
    const color = pickColor(uname);
    const newUser = {id, username:uname, usernameLower:uname.toLowerCase(), email, bio, lastActive:Date.now(), friends:[], avatarColor:color};
    users.push(newUser); saveUsers(users);
    setSession(id); currentUser=newUser; renderUserArea(); showPage('home');
  };
}

function renderProfile(){
  const s = getSession(); if(!s || !s.userId) { showPage('login'); return; }
  if(!currentUser) currentUser = findUserById(s.userId);
  if(!currentUser){ showPage('login'); return; }
  page.innerHTML = `
    <h2>Your Profile</h2>
    <div style="height:8px"></div>
    <div style="display:flex;gap:12px;align-items:flex-start">
      <div style="width:240px">
        <div class="card">
          <div style="display:flex;gap:12px;align-items:center">
            <div class="avatar" style="width:72px;height:72px;border-radius:12px;background:${currentUser.avatarColor};display:flex;align-items:center;justify-content:center;color:white;font-weight:700">${initials(currentUser.username)}</div>
            <div>
              <div style="font-weight:700">${escapeHtml(currentUser.username)}</div>
              <div class="small">${escapeHtml(currentUser.email||'')}</div>
              <div style="height:8px"></div>
            </div>
          </div>
        </div>
      </div>
      <div style="flex:1">
        <div class="card">
          <h4>Edit Profile</h4>
          <input id="editUser" placeholder="Username" style="width:100%;margin-top:8px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.04)" value="${escapeHtml(currentUser.username)}" />
          <textarea id="editBio" placeholder="Bio" style="width:100%;min-height:80px;margin-top:8px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.04)">${escapeHtml(currentUser.bio||'')}</textarea>
          <div style="height:12px"></div>
          <div style="display:flex;gap:8px"><button id="saveProfile" class="btn">Save</button><button id="logoutBtn" class="btn ghost">Logout</button></div>
        </div>
      </div>
    </div>
  `;

  document.getElementById('saveProfile').onclick = ()=>{
    const newU = document.getElementById('editUser').value.trim();
    const newBio = document.getElementById('editBio').value.trim();
    if(!newU) return alert('Username required');
    if(newU.toLowerCase() !== currentUser.usernameLower && findUserByUsername(newU)) return alert('Username taken');
    const users = loadUsers(); const idx = users.findIndex(u=>u.id===currentUser.id);
    users[idx].username = newU; users[idx].usernameLower = newU.toLowerCase(); users[idx].bio = newBio; users[idx].avatarColor = users[idx].avatarColor || pickColor(newU); saveUsers(users);
    currentUser = users[idx]; setSession(currentUser.id);
    // After saving, go directly to Home as requested
    renderUserArea(); showPage('home');
  };

  document.getElementById('logoutBtn').onclick = ()=>{
    // clear local session and call firebase signOut helper
    window.signOutFirebase().finally(()=>{
      clearSession(); showPage('login'); alert('You have been logged out successfully.');
    });
  };
}

function renderHome(){
  page.innerHTML = `
    <h2>Home</h2>
    <div style="height:12px"></div>
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:700">Welcome ${currentUser?escapeHtml(currentUser.username):'Guest'}</div>
          <div class="small">Start reading, help others, and explore</div>
        </div>
        <div style="width:280px;text-align:right"><div class="small">Featured</div></div>
      </div>
    </div>

    <div style="height:12px"></div>
    <div class="card"><h3>Featured Books</h3><div class="book-grid" id="homeBooks"></div></div>
  `;
  loadBooks().then(()=>{ const hb = document.getElementById('homeBooks'); hb.innerHTML=''; BOOKS.slice(0,6).forEach(b=> hb.appendChild(renderBookCard(b))); });
}

function renderEducation(){
  page.innerHTML = `<h2>Education</h2><div style="height:12px"></div><div class="card"><div class="tabs"><button class="tab active" data-filter="all">All</button><button class="tab" data-filter="science">Science</button><button class="tab" data-filter="math">Math</button><button class="tab" data-filter="history">History</button></div><div style="height:12px"></div><div class="book-grid" id="educationArea"></div></div>`;
  loadBooks().then(()=>{ renderEducationFilter('all'); const tabs = document.querySelectorAll('.card .tab'); tabs.forEach(t=> t.onclick=()=>{ tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active'); renderEducationFilter(t.dataset.filter); }); });
}
function renderEducationFilter(filter){ const node=document.getElementById('educationArea'); node.innerHTML=''; const list = BOOKS.filter(b=> {
  if(filter==='all') return b.type==='education';
  return b.type==='education' && (b.category===filter || (b.tags||[]).includes(filter));
}); list.forEach(b=> node.appendChild(renderBookCard(b))); }

function renderNovels(){ page.innerHTML = `<h2>Novels & Poems</h2><div style="height:12px"></div><div class="card"><div id="novelArea" class="book-grid"></div></div>`; loadBooks().then(()=>{ const node=document.getElementById('novelArea'); node.innerHTML=''; const list = BOOKS.filter(b=> b.type==='novel'); list.forEach(b=> node.appendChild(renderBookCard(b))); }); }

function renderLanguages(){ page.innerHTML = `<h2>Languages</h2><div class="card"><p class="small">Curated open resources for language learning.</p><div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px"><a class="tab" href="https://www.gutenberg.org" target="_blank">Project Gutenberg</a><a class="tab" href="https://openlibrary.org" target="_blank">OpenLibrary</a><a class="tab" href="https://archive.org" target="_blank">Internet Archive</a></div></div>`; }

function renderAITutor(){ page.innerHTML = `<h2>AI Tutor</h2><div style="height:12px"></div><div class="card"><h3 style="font-weight:800">Coming soon</h3><div class="small">I'll add a custom AI tutor here soon.</div></div>`; }

function renderQA(){ page.innerHTML = `<h2>Self-Test & Questions</h2><div style="height:8px"></div><div class="card"><h4>Ask a question</h4><input id="qTitle" placeholder="Short title" style="width:100%;margin-top:8px"/><div style="height:8px"></div><textarea id="qBody" placeholder="Describe your doubt" style="width:100%;min-height:80px"></textarea><div style="height:10px"></div><button id="postQBtn" class="btn">Post Question</button></div><div style="height:12px"></div><div id="questionsList"></div>`;
  renderQuestions();
  document.getElementById('postQBtn').onclick = ()=>{ if(!currentUser){ if(confirm('Login to post')) showPage('login'); return; } const t=document.getElementById('qTitle').value.trim(); const b=document.getElementById('qBody').value.trim(); if(!t) return alert('Title required'); const qa=read(LS_QA,{questions:[]}); qa.questions.unshift({id:createId('q'),title:t,body:b,authorId:currentUser.id,authorName:currentUser.username,createdAt:Date.now(),answers:[]}); write(LS_QA,qa); document.getElementById('qTitle').value=''; document.getElementById('qBody').value=''; renderQA(); };
}
function renderQuestions(){ const qa=read(LS_QA,{questions:[]}); const node=document.getElementById('questionsList'); node.innerHTML=''; qa.questions.forEach(q=>{ const div=document.createElement('div'); div.className='card'; div.style.marginBottom='8px'; div.innerHTML=`<strong>${escapeHtml(q.title)}</strong><div class="small">by ${escapeHtml(q.authorName)} ‚Ä¢ ${new Date(q.createdAt).toLocaleString()}</div><div style="height:8px"></div><div class="small">${escapeHtml(q.body)}</div><div style="height:8px"></div><div><button class="btn" onclick="openQuestion('${q.id}')">Open & Answer</button></div>`; node.appendChild(div); }); }
function openQuestion(id){ const qa=read(LS_QA,{questions:[]}); const q=qa.questions.find(x=>x.id===id); if(!q) return alert('Not found'); page.innerHTML = `<h3>${escapeHtml(q.title)}</h3><div class="small">by ${escapeHtml(q.authorName)}</div><div style="height:8px"></div><div class="card">${escapeHtml(q.body)}</div><div style="height:12px"></div><div class="card"><h4>Answers</h4><div id="answerList"></div><div style="height:8px"></div><textarea id="answerText" placeholder="Write your answer..." style="width:100%;min-height:80px"></textarea><div style="height:8px"></div><button id="postAnswerBtn" class="btn">Post Answer</button></div>`; const node=document.getElementById('answerList'); node.innerHTML=''; (q.answers||[]).forEach(a=>{ const block=document.createElement('div'); block.className='card'; block.style.marginBottom='8px'; block.innerHTML=`<strong>${escapeHtml(a.authorName)}</strong> <div class="small">${new Date(a.createdAt).toLocaleString()}</div><div style="height:8px"></div><div class="small">${escapeHtml(a.text)}</div>`; node.appendChild(block); }); document.getElementById('postAnswerBtn').onclick = ()=>{ if(!currentUser){ if(confirm('Login to answer')) showPage('login'); return; } const txt=document.getElementById('answerText').value.trim(); if(!txt) return alert('Write an answer'); const qa2=read(LS_QA,{questions:[]}); const q2=qa2.questions.find(x=>x.id===id); q2.answers=q2.answers||[]; q2.answers.push({id:createId('a'),text:txt,authorId:currentUser.id,authorName:currentUser.username,createdAt:Date.now()}); write(LS_QA,qa2); openQuestion(id); } }

function renderCommunity(){ const users = loadUsers().sort((a,b)=> (a.username> b.username?1:-1)); page.innerHTML = `<h2>Community</h2><div style="height:8px"></div><div id="communityList"></div>`; const node=document.getElementById('communityList'); users.forEach(u=>{ const card=document.createElement('div'); card.className='card'; card.style.marginBottom='8px'; card.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><div style="display:flex;gap:12px;align-items:center"><div class="avatar" style="background:${u.avatarColor};width:48px;height:48px;border-radius:8px;color:white;display:flex;align-items:center;justify-content:center;font-weight:700">${initials(u.username)}</div><div><div style="font-weight:700">${escapeHtml(u.username)}</div><div class="small">${escapeHtml(u.bio||'')}</div></div></div><div style="text-align:right"><div style="height:8px"></div><div><button class="btn" onclick="startChat('${u.id}')">Message</button> <button class="btn ghost" onclick="addFriend('${u.id}')">Add Friend</button></div></div></div>`; node.appendChild(card); }); }

/* ---------- Books ---------- */
async function loadBooks(){ if(BOOKS.length>0) return; try{ // attempt to load external file first
    const res = await fetch('books.json');
    if(res.ok){ BOOKS = await res.json(); }
  }catch(e){ /* ignore */ }
  // fallback sample data (covers use picsum.photos as safe placeholders)
  if(!BOOKS || BOOKS.length===0){ BOOKS = [
    {id:'b1',title:'Intro to Physics',author:'Various',type:'education',category:'science',tags:['science'],description:'Open resource on basic physics',license:'Public Domain',source_url:'https://archive.org',cover:`https://picsum.photos/seed/physics/200/300`},
    {id:'b2',title:'Algebra Essentials',author:'Math Collective',type:'education',category:'math',tags:['math'],description:'Foundational algebra course',license:'Public Domain',source_url:'https://openlibrary.org',cover:`https://picsum.photos/seed/algebra/200/300`},
    {id:'b3',title:'Selected Poems',author:'Classic Poets',type:'novel',category:'novel',tags:['novel'],description:'A small collection of public-domain poems',license:'Public Domain',source_url:'https://www.gutenberg.org',cover:`https://picsum.photos/seed/poems/200/300`},
    {id:'b4',title:'World History Overview',author:'History Guild',type:'education',category:'history',tags:['history'],description:'Survey course notes and readings',license:'Public Domain',source_url:'https://archive.org',cover:`https://picsum.photos/seed/history/200/300`}
  ]; write(LS_BOOKS, BOOKS); }
}

function renderBookCard(b){ const wrap = document.createElement('div'); wrap.className='book-card'; wrap.innerHTML = `<img class="book-cover" src="${encodeURI(b.cover||'https://picsum.photos/seed/book/200/300')}" alt="cover"/><div class="book-meta"><div class="book-title">${escapeHtml(b.title)}</div><div class="book-author">${escapeHtml(b.author||'Unknown')}</div><div class="small">${escapeHtml(b.description||'')}</div><div style="height:10px"></div><div class="book-actions"><button class="btn" onclick="openSource('${escapeForJs(b.source_url)}')">Open Source</button>${b.type==='novel'?'<button class="btn ghost" onclick="purchasePlaceholder(\''+b.id+'\')">Buy</button>':''}</div></div>`; return wrap; }

function openSource(url){ if(!url) return alert('No source available'); window.open(url,'_blank'); }
function purchasePlaceholder(id){ alert('This site does not host copyrighted files. Paid books must be purchased via official stores.'); }

/* ---------- Friends / Chat ---------- */
function loadFriendsList(){ friendsList.innerHTML=''; if(!currentUser){ friendsList.innerHTML='<div class="small">Login to see friends</div>'; return; } const friends = currentUser.friends||[]; if(friends.length===0){ friendsList.innerHTML='<div class="small">No friends yet</div>'; return; } friends.forEach(id=>{ const u=findUserById(id); if(!u) return; const d=document.createElement('div'); d.className='small'; d.innerHTML = `${escapeHtml(u.username)} <button class="btn ghost" style="margin-left:8px" onclick="startChat('${u.id}')">Chat</button>`; friendsList.appendChild(d); }); }

function addFriend(targetId){ if(!currentUser){ if(confirm('Login to add friends')) showPage('login'); return; } if(currentUser.id===targetId) return alert('Cannot add yourself'); const users=loadUsers(); const meIdx=users.findIndex(u=>u.id===currentUser.id); users[meIdx].friends = users[meIdx].friends||[]; if(users[meIdx].friends.includes(targetId)) return alert('Already friends'); users[meIdx].friends.push(targetId); saveUsers(users); currentUser = users[meIdx]; renderUserArea(); loadFriendsList(); }

function startChat(otherId){ if(!currentUser){ if(confirm('Login to chat')) showPage('login'); return; } const other = findUserById(otherId); if(!other) return alert('User not found'); activeChat = {peerId:otherId,peerName:other.username}; document.getElementById('chatWith').textContent = 'Chat ‚Äî ' + other.username; document.getElementById('chatPanel').classList.add('open'); loadChat(activeChat); }
function loadChat(room){ const all = read(LS_CHATS, {}); const id = chatRoomId(room.peerId, currentUser.id); const msgs = all[id] || []; const chatBody = document.getElementById('chatBody'); chatBody.innerHTML=''; msgs.forEach(m=>{ const d=document.createElement('div'); d.className='msg ' + (m.from===currentUser.id ? 'me' : 'them'); d.style.marginBottom='8px'; d.innerHTML=`<div style="font-size:13px">${escapeHtml(m.text)}</div><div class="small" style="margin-top:6px">${new Date(m.ts).toLocaleString()}</div>`; chatBody.appendChild(d); }); chatBody.scrollTop = chatBody.scrollHeight; }
function chatRoomId(a,b){ return [a,b].sort().join('_'); }
function sendMessage(){ const text = document.getElementById('chatText').value.trim(); if(!text || !activeChat) return; const all = read(LS_CHATS, {}); const id = chatRoomId(activeChat.peerId, currentUser.id); all[id] = all[id] || []; all[id].push({from:currentUser.id,to:activeChat.peerId,text,ts:Date.now()}); write(LS_CHATS, all); document.getElementById('chatText').value=''; loadChat(activeChat); }

document.getElementById('sendChat').onclick = ()=> sendMessage(); document.getElementById('closeChat').onclick = ()=> { document.getElementById('chatPanel').classList.remove('open'); activeChat=null; };

document.getElementById('openChatBtn').onclick = ()=> { if(!currentUser){ if(confirm('Login to chat')) showPage('login'); return; } const friends = currentUser.friends||[]; if(friends.length>0) startChat(friends[0]); else alert('You have no friends yet. Use Community to add friends.'); };

/* ---------- Utilities ---------- */
function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function initials(name){ return (name||'').split(' ').map(x=>x[0]||'').slice(0,2).join('').toUpperCase(); }
function pickColor(seed){ const palette=['#b98a2b','#a97e2b','#c79a3d','#9a7a2b','#d4a24a','#8f6b2a']; let h=0; for(let i=0;i<seed.length;i++) h=(h<<5)-h+seed.charCodeAt(i); return palette[Math.abs(h)%palette.length]; }
function renderUserArea(){ const s = getSession(); if(s && s.userId){ currentUser = findUserById(s.userId); userArea.innerHTML = `<strong style="color:var(--gold)">${escapeHtml(currentUser.username)}</strong>`; loginTab.classList.add('hidden'); } else { userArea.innerHTML = 'Not signed in'; loginTab.classList.remove('hidden'); }
  loadFriendsList(); }

function escapeForJs(s){ return (s||'').replace(/'/g,"\\'").replace(/"/g,'\\"'); }

/* theme toggle */
const themeToggle = document.getElementById('themeToggle'); themeToggle.onclick = ()=>{
  const el = document.documentElement; const cur = el.getAttribute('data-theme'); el.setAttribute('data-theme', cur==='dark'?'light':'dark');
};

/* Init */
async function init(){ await loadBooks(); const s = getSession(); if(s && s.userId){ currentUser = findUserById(s.userId); renderUserArea(); showPage('home'); } else { showPage('login'); }
  // wire nav profile btn
  document.getElementById('navProfileBtn').onclick = ()=> showPage('profile');
  // global search
  document.getElementById('globalSearch').oninput = async ()=>{ const q = document.getElementById('globalSearch').value.trim().toLowerCase(); if(!q){ showPage('home'); return; } await loadBooks(); const matches = BOOKS.filter(b=> (b.title+' '+(b.author||'')+' '+(b.description||'')).toLowerCase().includes(q)); page.innerHTML = `<h2>Search results for "${escapeHtml(document.getElementById('globalSearch').value)}"</h2><div class="book-grid" id="searchResults"></div>`; const node=document.getElementById('searchResults'); matches.forEach(b=> node.appendChild(renderBookCard(b))); };
  // small side nav shortcuts
  sideNavList.querySelectorAll('.tab').forEach(t=> t.onclick = ()=> showPage(t.dataset.page));
}
init();

/* helper to open external url from book card in global scope */
window.openSource = openSource;
window.startChat = startChat;
window.addFriend = addFriend;
window.openChat = ()=> document.getElementById('chatPanel').classList.add('open');
window.purchasePlaceholder = purchasePlaceholder;

</script>
</body>
</html>
